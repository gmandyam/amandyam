<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml' lang='en'>
  <head>
    <meta charset='utf-8'/>
    <title>Enhanced Geolocation</title>
    <script class='remove'>
      var respecConfig = {
          specStatus: "ED"
      ,   shortName:  "enhanced-geolocation"
      ,   editors: [
         {   name:       "Giridhar Mandyam"
                ,   company:    "Qualcomm Innovation Center, Inc"
                ,   companyURL: "http://www.qualcomm.com/about/businesses/quicinc" }
          ]
      ,   edDraftURI:   "http://gmandyam.github.com/enhanced-geolocation"
      ,   previousURI:   "http://gmandyam.github.com/enhanced-geolocation"
      ,   copyrightStart: 2012
      ,   noIDLIn:      true
      ,   wg:           "Systems Applications Working Group"
      ,   wgURI:        "http://www.w3.org/2012/sysapps/"
      ,   wgPublicList: "public-sysapps"
      ,   wgPatentURI:  "XXX"
      ,   isRecTrack:   false
      ,   isNoTrack:    true
      ,   format:       'markdown'
      };
    </script>
    <script src='./respec.js' class='remove' async></script>
  </head>
  <body>
    <section id='sotd'>
      Comments on this document are welcomed.
    </section>
    
    <section id='abstract'>
      This document specifies the necessary enhancements to the Geolocation API [[!GEOLOCATION-API]] for loaction-enabled Web applications to have similar capabilities to native applications.
    </section>
    
    Introduction
    ------------
    <p>The interfaces defined in this document are partial interfaces with respect to the <code>Geolocation</code> object defined
    in [[!GEOLOCATION-API]].  The primary extensions are related to geofencing and indoor positioning.</p>
    
    Extensions to the <code>Geolocation</code> Interface
    --------------
    <dl title='partial interface Geolocation' class='idl'>
    <dd>partial interface Geolocation</dd>
    <dt>void getCurrentProximityStatus(in CurrentProximityCallback successCallback, in WatchProximitySettings settings, in optional PositionErrorCallback errorCallback, in optional PositionOptions options)</dt>
    <dd>The <code>getCurrentProximityStatus()</code> method takes up to three arguments. When called, it must immediately return and then asynchronously attempt to obtain the current location of the device and compare it to the geofence boundaries provided in <code>settings</code>. 
    If the attempt is successful, the successCallback must be invoked with a new ProximityState object, reflecting the current location of the device with respect to the geofence. 
    If the attempt fails, the errorCallback must be invoked with a new PositionError object, reflecting the reason for the failure.</dd>
    <dt>long watchProximity(in ProximityCallback successCallback, in WatchProximitySettings settings, in optional PositionErrorCallback errorCallback, in optional PositionOptions options)</dt>
    <dd>The <code>watchProximity()</code> method takes up to three arguments. When called, it must immediately return a long value that uniquely identifies a watch operation and then asynchronously start the watch operation. 
    This operation must first attempt to obtain the current proximity status of the device. If the attempt is successful, the successCallback must be invoked (i.e. the <code>handleEvent()</code> operation must be called on the callback object) with a new Position object, reflecting the current location of the device. If the attempt fails, the errorCallback must be invoked with a new PositionError object, reflecting the reason for the failure. 
    The watch operation then must continue to monitor the position of the device and invoke the appropriate callback every time the position changes sufficiently so that a breach of the geofence described in <code>settings</code> occurs. The watch operation must continue until the <code>clearWatch</code> method as defined in [[!GEOLOCATION-API]] is called with the corresponding identifier.</dd>
    </dl>      
    
    <code>CurrentProximityCallback</code>
    -------
    <dl title='[Callback=FunctionOnly, NoInterfaceObject] interface CurrentProximityCallback' class='idl'>
    <dt>void handleEvent(in Position position, in ProximityState proximityState)</dt>
    <dd>The <code>handleEvent()</code> function of a <code>CurrentProximityCallback</code> callback function <em title="must" class="rfc2119">must</em> be passed new <code>Position</code> and <code>ProximityState</code> objects when the <code>getCurrentProximity()</code> method is called successfully.</dd>
    </dl> 
        
    <code>ProximityCallback</code>
    -------
    <dl title='[Callback=FunctionOnly, NoInterfaceObject] interface ProximityCallback' class='idl'>
    <dt>void handleEvent(in Position position, in ProximityState proximityState)</dt>
    <dd>The <code>handleEvent()</code> function of a <code>ProximityCallback</code> callback function <em title="must" class="rfc2119">must</em> be passed new <code>Position</code> and <code>ProximityState</code> objects when the <code>watchProximity()</code> method is called successfully and a breach of the geofence corresponding to the watch operation
    has been determined to occur.</dd>
    </dl> 
    
    
    <code>WatchProximitySettings</code>
    -------
    <p>This interface defines a circular geofence with a centroid and radius.</p>
    <dl title='[Callback, NoInterfaceObject] interface WatchProximitySettings' class='idl'>
    <dt>attribute double latitude</dt>
    <dd>Latitude of centroid for geofence</dd>
    <dt>attribute double longitude</dt>
    <dd>Longitude of centroid for geofence</dd>
    <dt>attribute double radius</dt>
    <dd>Radius of geofence in meters</dd>
    </dl>
    
    <code>PositionError</code> Extensions
    -------
    <p>The <code>PositionError</code> interface defined in [[!GEOLOCATION-API]] is extended to include geofencing error status.</p>
    <dl title='partial interface PositionError' class='idl'>
    <dt>const unsigned short WATCH_PROXIMITY_FAILED = 4</dt>
    <dd>Error code for failure for proximity-based watch process</dd>
    </dl>
    
    <code>ProximityState</code>
    -------
    <p>This interface defines a geofence breach event, where the device enters or leaves the boundary of the geofence defined
    by the <code>WatchProximitySettings</code> object passed into a <code>getCurrentProximity()</code> or <code>watchProximity()</code>
    method.</p>
    <dl title='interface WatchProximitySettings' class='idl'>
    <dt>const unsigned short ENTERING_INSIDE = 0</dt>
    <dd>If the <code>WatchProximitySettings</code> object is being returned to a <code>CurrentProximityCallback</code> and the device is currently inside the geofence, then 
    <code>breachDirection</code> is set to this value. If the <code>WatchProximitySettings</code> object is being returned to a <code>=ProximityCallback</code> and the device is currently entering inside the geofence, then 
    <code>breachDirection</code> is set to this value.</dd>
    <dt>const unsigned short LEAVING_OUTSIDE = 1</dt>
    <dd>If the <code>WatchProximitySettings</code> object is being returned to a <code>CurrentProximityCallback</code> and the device is currently outside of the geofence, then 
    <code>breachDirection</code> is set to this value. If the <code>WatchProximitySettings</code> object is being returned to a <code>=ProximityCallback</code> and the device is currently exiting the geofence, then 
    <code>breachDirection</code> is set to this value.</dd>
    <dt>const unsigned short UNKNOWN = 3</dt>
    <dd><code>breachDirection</code> is set to this value if the User Agent is unable to determine the location of the device relative to the geofence.</dd>
    <dt>readonly attribute unsigned short breachDirection</dt>
    <dd>This attribute describes the current status of the device with respect to the geofence.</dd>
    </dl>

    <code>Positon</code> Extensions
    -------
    <p>Enhancements to the <code>Position</code> object defined in [[!GEOLOCATION-API]] are necessary when indoor location determination is available to the User Agent.  In addition to latitude and longitude, additional information describing the location is returned in the <code>Position</code> object that further describes the location. If this information is unavailable, then the values of these new attributes must all be set to null.</p>
    <dl title='partial interface Position' class='idl'>
    <dt>readonly attribute double floorNumber</dt>
    <dd>The floor number corresponding to the building at the current location.  A value of 1.0 would indicate the first floor, 1.5 would indicate mezzanine, etc.</dd>
    <dt>readonly attribute any mapInfo</dt>
    <dd><code>mapInfo</code> represents the JSON-serializable data associated with the venue, e.g. {"mapProvider": "Bing", "mapURL": "http://someplace.anywhere"}</dd>
    <dt>readonly attribute DOMString venueID</dt>
    <dd>Text that describes the venue corresponding to the current device location, e.g. The White House.</dd>
    </dl> 
        
    Examples
    -------
    ##### Display Geofence Breach Events
    <pre class='example'>
function updateDisplay(position, proxState) {
        // Displays geofence event
        if (proxState.breachDirection == 0) {
            document.write('Entered geofence at ' + position.coords.latitude + ', ' + position.coords.longitude + '&ltbr&gt');
            }
        else {
            if (proxState.breachDirection == 1) {
                document.write('Exited geofence at ' + position.coords.latitude + ', ' + position.coords.longitude + '&ltbr&gt');
                }
            else {
                document.write ('Status unknown' + '&ltbr&gt');
                }
            }

        }

    // Set geofence
    var gf = {};
    gf.latitude = 32.895732;
    gf.longitude = -117.195861;
    gf.radius = 10.5;
    gf.timeout = 80000;

    // Request geofence
    var watchProximityId = navigator.geolocation.watchProximity(updateDisplay,gf);

    function buttonClickHandler() {
      // Cancel the geofence when the user clicks a button.
      navigator.geolocation.clearWatch(watchProximityId);
    }

    </pre>   
  </body>
</html>
